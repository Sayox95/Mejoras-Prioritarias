<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspecciones v2 - Mobile con FAB de filtros</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; position: relative; }
    #loading-overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2em; z-index: 1000;
    }
    #data-loading {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      z-index: 1005;
    
      flex-direction: column;
    }

    /* Spinner circular */
    #data-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* FAB de filtros */
    #filter-fab {
      position: absolute;
      bottom: 16px; right: 16px;
      width: 56px; height: 56px;
      border-radius: 50%;
      background: #007bff; color: white;
      border: none;
      font-size: 24px;
      z-index: 1003;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex; align-items: center; justify-content: center;
    }
    /* Bottom sheet para filtros */
    #filter-sheet {
      position: absolute; bottom: 0; left: 0;
      width: 100%; max-height: 50%;
      background: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
      border-top-left-radius: 12px; border-top-right-radius: 12px;
      transform: translateY(100%); transition: transform 0.3s ease;
      z-index: 1002; overflow-y: auto;
    }
    #filter-sheet.open { transform: translateY(0); }
    #filter-header {
      padding: 12px; border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-between; align-items: center;
    }
    #filter-header h2 { margin: 0; font-size: 1.2em; }
    #close-filter {
      background: transparent; border: none; font-size: 1.5em; cursor: pointer;
    }
    #filter-content { padding: 12px; }
    #filter-content label {
      display: block; margin-bottom: 8px; font-size: 1em;
    }
    #filter-content select {
      width: 100%; padding: 8px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;
    }
    #apply-filters {
      margin-top: 12px; padding: 12px;
      width: 100%; font-size: 1em;
      border: none; border-radius: 6px; background: #28a745; color: white;
    }
    /* Bottom sheet para inspección */
    #sheet {
      position: absolute; bottom: 0; left: 0;
      width: 100%; max-height: 80%;
      background: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
      border-top-left-radius: 12px; border-top-right-radius: 12px;
      transform: translateY(100%); transition: transform 0.3s ease;
      z-index: 1001; overflow-y: auto;
    }
    #sheet.open { transform: translateY(0); }
    #sheet-header {
      padding: 12px; border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-between; align-items: center;
    }
    #sheet-header h2 { margin: 0; font-size: 1.2em; }
    #close-sheet {
      background: transparent; border: none; font-size: 1.5em; cursor: pointer;
    }
    #progress { padding: 0 12px; font-size: 0.9em; color: #555; }
    details { margin: 8px 12px; }
    summary {
      font-weight: bold; font-size: 1em; padding: 8px;
      background: #f5f5f5; border-radius: 4px; cursor: pointer;
    }
    details[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    details div { padding: 8px; border: 1px solid #f5f5f5; border-top: none; }
    label { display: block; margin: 8px 0 4px; font-size: 0.9em; }
    input[readonly], input, select, textarea {
      width: 100%; box-sizing: border-box; padding: 8px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 4px;
    }
    textarea { resize: vertical; height: 60px; }
    button#save-btn {
      margin: 12px; padding: 12px; width: calc(100% - 24px);
      font-size: 1em; border: none; border-radius: 6px;
      background: #007bff; color: white; cursor: pointer;
    }
    /* Snackbar */
    #snackbar {
      visibility: hidden; min-width: 200px; margin-left: -100px;
      background-color: #333; color: #fff; text-align: center;
      border-radius: 4px; padding: 12px; position: fixed;
      left: 50%; bottom: 30px; font-size: 1em; z-index: 1004;
    }
    #snackbar.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
    @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
  </style>
</head>
<body>
  <div id="map">
    <div id="loading-overlay">Cargando información...</div>
    <div id="data-loading">
    <div class="spinner"></div>
    <div>Cargando Datos...</div>
  </div>
  </div>
  <button id="filter-fab">🔍</button>
  <div id="filter-sheet">
    <div id="filter-header">
      <h2>Filtros</h2>
      <button id="close-filter">&times;</button>
    </div>
    <div id="filter-content">
      <label>Sector:
        <select id="sectorFilter">
          <option value="all">Todos los sectores</option>
        </select>
      </label>
      <button id="apply-filters">Aplicar</button>
    </div>
  </div>

  <div id="sheet">
    <div id="sheet-header">
      <h2>Inspección Centro</h2>
      <button id="close-sheet">&times;</button>
    </div>
    <div id="progress">Paso 1 de 3</div>
    <form id="inspection-form" data-centro-id="">
      <details open>
        <summary>Datos del Centro</summary>
        <div>
          <label>Region PNRP:<input type="text" id="regionPNRP" readonly /></label>
          <label>Procede:<input type="text" id="procede" readonly /></label>
          <label>Sector:<input type="text" id="sector" readonly /></label>
          <label>Nombre:<input type="text" id="nombre" readonly /></label>
          <label>Municipio:<input type="text" id="municipio" readonly /></label>
        </div>
      </details>
      <details>
        <summary>Ubicación y Circuito</summary>
        <div>
          <label>Latitud:<input type="text" id="latitud" readonly /></label>
          <label>Longitud:<input type="text" id="longitud" readonly /></label>
          <label>Circuito:<input type="text" id="circuito" readonly /></label>
          <label>Voltaje:<input type="text" id="voltaje" readonly /></label>
        </div>
      </details>
      <details>
        <summary>Inspección y Observaciones</summary>
        <div>
          <label>Capacidad Transformador (kVA):<input type="number" id="capacidadTransformador" /></label>
          <label>ID transformador:<input type="text" id="idTransformador" /></label>
          <label>Cantidad de Clientes:<input type="number" id="cantidadClientes" required /></label>
          <label>Riesgos Naturales:<select id="riesgosNaturales"><option value="">Seleccione</option><option>Sí</option><option>No</option></select></label>
          <label>Observación Riesgos:<textarea id="observacionRiesgosNaturales"></textarea></label>
        </div>
      </details>
      <button type="submit" id="save-btn">Guardar Respuestas</button>
    </form>
  </div>

  <div id="snackbar">Guardado exitoso</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    var SHEET_API_BASE = 'https://script.google.com/macros/s/AKfycbwChmqh1x5ZxzrtBo4pxB1mLys7LFhwj7SXpo1AwIWXQpfG7YgdMc70Am5MNEFJ-nsHCg/exec';
    var map = L.map('map').setView([0,0],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    var overlay = document.getElementById('loading-overlay');
    var filterFab = document.getElementById('filter-fab');
    var filterSheet = document.getElementById('filter-sheet');
    var closeFilter = document.getElementById('close-filter');
    var applyFilters = document.getElementById('apply-filters');
    var sheet = document.getElementById('sheet');
    var closeBtn = document.getElementById('close-sheet');
    var snackbar = document.getElementById('snackbar');
    var dataSpinner = document.getElementById('data-loading');
    var markers = [];
    var sectors = new Set();

    function loadMarkers() {
      overlay.style.display = 'flex';
      fetch(SHEET_API_BASE + '?action=getAllCentros')
        .then(function(res) { return res.json(); })
        .then(function(centros) {
          // extraer sectores definidos
          centros.forEach(function(c) {
            if(c.sector) sectors.add(c.sector);
          });
          populateFilter();
          // crear marcadores
          var bounds = [];
          centros.forEach(function(c) {
            var lat = parseFloat(c.latitud), lng = parseFloat(c.longitud);
            if (!isNaN(lat) && !isNaN(lng)) {
              var m = L.marker([lat,lng]).addTo(map);
              m.id = c.id; m.sector = c.sector;
              var popupContent = '<div><strong>' + (c.nombre||'') + '</strong><br><button onclick="openSheet(\'' + c.id + '\')">Inspeccionar</button></div>';
              m.bindPopup(popupContent);
              markers.push(m);
              bounds.push([lat,lng]);
            }
          });
          if (bounds.length) map.fitBounds(bounds, { padding: [20,20] });
        })
        .catch(function(e) { console.error(e); })
        .finally(function() { overlay.style.display = 'none'; });
    }

    function populateFilter() {
      var select = document.getElementById('sectorFilter');
      // limpiar excepto primer opción
      select.innerHTML = '<option value="all">Todos los sectores</option>';
      sectors.forEach(function(sec) {
        var opt = document.createElement('option');
        opt.value = sec; opt.textContent = sec;
        select.appendChild(opt);
      });
    }

    filterFab.onclick = function() {
      filterSheet.classList.add('open');
    };
    closeFilter.onclick = function() {
      filterSheet.classList.remove('open');
    };
    applyFilters.onclick = function() {
      var sel = document.getElementById('sectorFilter').value;
      filterSheet.classList.remove('open');
      var visibleBounds = [];
      markers.forEach(function(m) {
        if (sel === 'all' || m.sector === sel) {
          map.addLayer(m);
          visibleBounds.push(m.getLatLng());
        } else {
          map.removeLayer(m);
        }
      });
      if (visibleBounds.length) map.fitBounds(visibleBounds, { padding: [20,20] });
    };

    function openSheet(id) {
      dataSpinner.style.display = 'flex';
      fetch(SHEET_API_BASE + '?action=getCentro&id=' + id)
        .then(response => response.json())
        .then(data => {
          ['regionPNRP','procede','sector','nombre','municipio','latitud','longitud','circuito','voltaje']
            .forEach(f => document.getElementById(f).value = data[f] || '');
          document.getElementById('inspection-form').dataset.centroId = id;
          dataSpinner.style.display = 'none';
          sheet.classList.add('open');
        })
        .catch(err => {
          console.error(err);
          dataSpinner.style.display = 'none';
        });
    }

    closeBtn.onclick = function() { sheet.classList.remove('open'); };

    document.getElementById('inspection-form').onsubmit = function(e) {
      e.preventDefault();
      var id = this.dataset.centroId;
      var respuestas = {
        capacidadTransformador: document.getElementById('capacidadTransformador').value,
        idTransformador: document.getElementById('idTransformador').value,
        cantidadClientes: document.getElementById('cantidadClientes').value,
        riesgosNaturales: document.getElementById('riesgosNaturales').value,
        observacionRiesgosNaturales: document.getElementById('observacionRiesgosNaturales').value
      };
      fetch(SHEET_API_BASE + '?action=saveRespuestas&id=' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ respuestas: respuestas })
      })
      .then(function(resp) {
        if (resp.ok) {
          sheet.classList.remove('open');
          snackbar.classList.add('show');
          setTimeout(function() { snackbar.classList.remove('show'); }, 3000);
        }
      }).catch(function(e) { console.error(e); });
    };

    loadMarkers();
  </script>
</body>
</html>
