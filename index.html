<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Inspecciones v2 - Mobile con FAB de filtros</title>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map { height: 100%; width: 100%; position: relative; }
    #loading-overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2em; z-index: 1000;
    }
    #data-loading {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      z-index: 1005;
    
      flex-direction: column;
    }
    /* Overlay para ‚ÄúGuardando informaci√≥n‚Ä¶‚Äù */
    #save-loading {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      z-index: 2005;           /* Por encima del sheet (z-index:2000) */
      flex-direction: column;
    }


    /* Spinner circular */
    #data-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    #save-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }
    

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* FAB de filtros */
    #filter-fab {
      position: absolute;
      bottom: 16px; right: 16px;
      width: 56px; height: 56px;
      border-radius: 50%;
      background: #007bff; color: white;
      border: none;
      font-size: 24px;
      z-index: 1003;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: flex; align-items: center; justify-content: center;
    }
    /* Bottom sheet para filtros */
    #filter-sheet {
      position: absolute; bottom: 0; left: 0;
      width: 100%; max-height: 50%;
      background: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
      border-top-left-radius: 12px; border-top-right-radius: 12px;
      transform: translateY(100%); transition: transform 0.3s ease;
      z-index: 1002; overflow-y: auto;
    }
    #filter-sheet.open { transform: translateY(0); }
    #filter-header {
      padding: 12px; border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-between; align-items: center;
    }
    #filter-header h2 { margin: 0; font-size: 1.2em; }
    #close-filter {
      background: transparent; border: none; font-size: 1.5em; cursor: pointer;
    }
    #filter-content { padding: 12px; }
    #filter-content label {
      display: block; margin-bottom: 8px; font-size: 1em;
    }
    #filter-content select {
      width: 100%; padding: 8px; font-size: 1em; border-radius: 4px; border: 1px solid #ccc;
    }
    #apply-filters {
      margin-top: 12px; padding: 12px;
      width: 100%; font-size: 1em;
      border: none; border-radius: 6px; background: #28a745; color: white;
    }
    /* Bottom sheet para inspecci√≥n */
    #sheet {
      position: absolute; bottom: 0; left: 0;
      width: 100%; max-height: 80%;
      background: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
      border-top-left-radius: 12px; border-top-right-radius: 12px;
      transform: translateY(100%); transition: transform 0.3s ease;
      z-index: 2000; overflow-y: auto;
    }
    #sheet.open { transform: translateY(0); }
    #sheet-header {
      padding: 12px; border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-between; align-items: center;
    }
    #sheet-header h2 { margin: 0; font-size: 1.2em; }
    #close-sheet {
      background: transparent; border: none; font-size: 1.5em; cursor: pointer;
    }
    #progress { padding: 0 12px; font-size: 0.9em; color: #555; }
    details { margin: 8px 12px; }
    summary {
      font-weight: bold; font-size: 1em; padding: 8px;
      background: #f5f5f5; border-radius: 4px; cursor: pointer;
    }
    details[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    details div { padding: 8px; border: 1px solid #f5f5f5; border-top: none; }
    label { display: block; margin: 8px 0 4px; font-size: 0.9em; }
    input[readonly], input, select, textarea {
      width: 100%; box-sizing: border-box; padding: 8px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 4px;
    }
    textarea { resize: vertical; height: 60px; }
    button#save-btn {
      margin: 12px; padding: 12px; width: calc(100% - 24px);
      font-size: 1em; border: none; border-radius: 6px;
      background: #007bff; color: white; cursor: pointer;
    }
    /* Snackbar */
    #snackbar {
      visibility: hidden; min-width: 200px; margin-left: -100px;
      background-color: #333; color: #fff; text-align: center;
      border-radius: 4px; padding: 12px; position: fixed;
      left: 50%; bottom: 30px; font-size: 1em; z-index: 1004;
    }
    #snackbar.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
    @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
  
    /* Text styling for saving overlay */
    #save-loading .save-text {
      font-size: 1.2em;
      margin-top: 10px;
      color: #333;
    }
    </style>
</head>
<body>
<div id="map">
<div id="loading-overlay">Cargando informaci√≥n...</div>
<div id="data-loading">
<div class="spinner"></div>
<div>Cargando Datos...</div>
</div>
<div id="save-loading">
<div class="spinner"></div>
<div class="save-text">Guardando informaci√≥n...</div>
</div>
</div>
<button id="filter-fab">üîç</button>
<div id="filter-sheet">
<div id="filter-header">
<h2>Filtros</h2>
<button id="close-filter">√ó</button>
</div>
<div id="filter-content">
<label>Sector:
        <select id="sectorFilter">
<option value="all">Todos los sectores</option>
</select>
</label>
<label>Estado:
        <select id="estadoFilter">
<option value="all">Todos los estados</option>
<option value="Pendiente">Pendiente</option>
<option value="Completado">Completado</option>
</select>
</label>
<button id="apply-filters">Aplicar</button>
</div>
</div>
<div id="sheet">
<div id="sheet-header">
<h2>Inspecci√≥n Centro</h2>
<button id="close-sheet">√ó</button>
</div>
<div id="progress">Paso 1 de 3</div>
<form data-centro-id="" id="inspection-form">
<details open="">
<summary>Datos del Centro</summary>
<div>
<label>Region PNRP:<input id="regionPNRP" readonly="" type="text"/></label>
<label>Procede:<input id="procede" readonly="" type="text"/></label>
<label>Sector:<input id="sector" readonly="" type="text"/></label>
<label>Nombre:<input id="nombre" readonly="" type="text"/></label>
<label>Municipio:<input id="municipio" readonly="" type="text"/></label>
</div>
</details>
<details>
<summary>Ubicaci√≥n y Circuito</summary>
<div>
<label>Latitud:<input id="latitud" readonly="" type="text"/></label>
<label>Longitud:<input id="longitud" readonly="" type="text"/></label>
<label>Circuito:<input id="circuito" readonly="" type="text"/></label>
<label>Voltaje:<input id="voltaje" readonly="" type="text"/></label>
</div>
</details><details><summary>Fotograf√≠as</summary><div>
<label>Subir o tomar fotograf√≠as:
  <input accept="image/*" capture="environment" id="fotosInput" multiple="" type="file"/>
</label>
<div id="miniaturasFotos" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
</div></details>
<details>
<summary>Inspecci√≥n y Observaciones</summary>
<div>
<label>Supervisor UCTD-ENEE:<input id="supervisorUCTD" type="text"/></label>
<label>Capacidad Transformador existente m√°s cercano (kVA):<input id="capacidadTransformador" type="number"/></label>
<label>ID transformador:<input id="idTransformador" type="text"/></label>
<label>C√≥digo Apoyo:<input id="codigoApoyo" type="text"/></label>
<label>Cantidad de Clientes (Obligatorio):<input id="cantidadClientes" required="" type="number"/></label>
<label>Riesgos Naturales:
      <select id="riesgosNaturales">
<option value="">Seleccione</option>
<option>S√≠</option>
<option>No</option>
</select>
</label>
<label>Observacion Riesgos Naturales:<textarea id="observacionRiesgosNaturales"></textarea></label>
<label>Requerimiento de Acompa√±amiento de Polic√≠a o Ej√©rcito:
      <select id="requerimientoAcompanamiento">
<option value="">Seleccione</option>
<option>S√≠</option>
<option>No</option>
</select>
</label>
<label>Observacion Requerimiento de Acompa√±amiento:<textarea id="observacionAcompanamiento"></textarea></label>
<label>Presencia de Pandillas o Actores al Margen de la Ley:
      <select id="presenciaPandillas">
<option value="">Seleccione</option>
<option>S√≠</option>
<option>No</option>
</select>
</label>
<label>Observacion Presencia de Pandillas:<textarea id="observacionPandillas"></textarea></label>
<label>Otros:<select id="otros"><option value="">Seleccione</option><option value="S√≠">S√≠</option><option value="No">No</option></select></label>
<label>Observacion Otros:<textarea id="observacionOtros"></textarea></label>
</div>
</details><details>
<summary>Evaluaci√≥n de Conflictividad y Responsable</summary>
<div>
<label for="nivelConflictividad">Nivel de Conflictividad - Renuencia:
    <select id="nivelConflictividad">
<option value="">Seleccione</option>
<option>Alto</option>
<option>Medio</option>
<option>Bajo</option>
</select>
</label>
<label for="observacionConflictividad">Observaci√≥n:
    <input id="observacionConflictividad" type="text"/>
</label>
<label for="nivelRiesgo">Nivel de Riesgo Asociado:
    <select id="nivelRiesgo">
<option value="">Seleccione</option>
<option>Alto</option>
<option>Medio</option>
<option>Bajo</option>
</select>
</label>
<label for="observacionRiesgo">Observaci√≥n:
    <input id="observacionRiesgo" type="text"/>
</label>
<label for="nombreResponsable">Nombre Completo:
    <input id="nombreResponsable" type="text"/>
</label>
<label for="cargoResponsable">Cargo:
    <input id="cargoResponsable" type="text"/>
</label>
<label for="institucionResponsable">Instituci√≥n / Patronato:
    <input id="institucionResponsable" type="text"/>
</label>
<label for="telefonosResponsable">Tel√©fonos:
    <input id="telefonosResponsable" type="text"/>
</label>
<label for="observacionesGenerales">Observaciones generales:
    <textarea id="observacionesGenerales"></textarea>
</label>
</div>
</details><button id="save-btn" type="submit">Guardar Respuestas</button>
</form>
</div>
<div id="snackbar">Guardado exitoso</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var SHEET_API_BASE = 'https://script.google.com/macros/s/AKfycbwZInrEt79z0oq1_waFyrvvBTZm3D1Unazj9qf4LmFRIiP94iTw1EueL6bUe1rFroELDw/exec';
    var map = L.map('map').setView([0,0],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    
    var redIcon = new L.Icon({
      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    var greenIcon = new L.Icon({
      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    var overlay = document.getElementById('loading-overlay');
    var filterFab = document.getElementById('filter-fab');
    var filterSheet = document.getElementById('filter-sheet');
    var closeFilter = document.getElementById('close-filter');
    var applyFilters = document.getElementById('apply-filters');
    var sheet = document.getElementById('sheet');
    var closeBtn = document.getElementById('close-sheet');
    var snackbar = document.getElementById('snackbar');
    var dataSpinner = document.getElementById('data-loading');
    var saveSpinner = document.getElementById('save-loading');
    var filterFab = document.getElementById('filter-fab');
    var filterSheet = document.getElementById('filter-sheet');
    var filterFab = document.getElementById('filter-fab');
    var filterSheet = document.getElementById('filter-sheet');
    var markers = [];
    var sectors = new Set();

    function loadMarkers() {
      overlay.style.display = 'flex';
      fetch(SHEET_API_BASE + '?action=getAllCentros')
        .then(function(res) { return res.json(); })
        .then(function(centros) {
          // extraer sectores definidos
          centros.forEach(function(c) {
            if(c.sector) sectors.add(c.sector);
          });
          populateFilter();
          // crear marcadores
          var bounds = [];
          centros.forEach(function(c) {
            var lat = parseFloat(c.latitud), lng = parseFloat(c.longitud);
            if (!isNaN(lat) && !isNaN(lng)) {
              var icon = (c.estado === 'Completado') ? greenIcon : redIcon;
              var m = L.marker([lat,lng], { icon: icon }).addTo(map);
              m.id = c.id; m.sector = c.sector; m.estado = c.estado;
              var popupContent = '<div><strong>' + (c.nombre||'') + '</strong><br><button onclick="openSheet(\'' + c.id + '\')">Inspeccionar</button></div>';
              m.bindPopup(popupContent);
              markers.push(m);
              bounds.push([lat,lng]);
            }
          });
          if (bounds.length) map.fitBounds(bounds, { padding: [20,20] });
        })
        .catch(function(e) { console.error(e); })
        .finally(function() { overlay.style.display = 'none'; });
    }

    function populateFilter() {
      var select = document.getElementById('sectorFilter');
      // limpiar excepto primer opci√≥n
      select.innerHTML = '<option value="all">Todos los sectores</option>';
      sectors.forEach(function(sec) {
        var opt = document.createElement('option');
        opt.value = sec; opt.textContent = sec;
        select.appendChild(opt);
      });
    }

    filterFab.onclick = function() {
      filterSheet.classList.add('open');
    };
    closeFilter.onclick = function() {
      filterSheet.classList.remove('open');
    };
    applyFilters.onclick = function() {
      var sel = document.getElementById('sectorFilter').value;
      var estadoSel = document.getElementById('estadoFilter').value;
      filterSheet.classList.remove('open');
      var visibleBounds = [];
      markers.forEach(function(m) {
        if ((sel === 'all' || m.sector === sel) &&
          (estadoSel === 'all' || (estadoSel === 'Completado' && m.options.icon === greenIcon) || (estadoSel === 'Pendiente' && m.options.icon === redIcon))) {
          map.addLayer(m);
          visibleBounds.push(m.getLatLng());
        } else {
          map.removeLayer(m);
        }
      });
      if (visibleBounds.length) map.fitBounds(visibleBounds, { padding: [20,20] });
    };

    function openSheet(id) {
      filterFab.style.display = 'none';
      filterSheet.style.display = 'none';
      dataSpinner.style.display = 'flex';
      fetch(SHEET_API_BASE + '?action=getCentro&id=' + id)
        .then(response => response.json())
        .then(data => {
          ['regionPNRP','procede','sector','nombre','municipio','latitud','longitud','circuito','voltaje']
            .forEach(f => document.getElementById(f).value = data[f] || '');
          document.getElementById('inspection-form').dataset.centroId = id;
          dataSpinner.style.display = 'none';
          sheet.classList.add('open');
        })
        .catch(err => {
          console.error(err);
          dataSpinner.style.display = 'none';
        });
    }

    closeBtn.onclick = function() { sheet.classList.remove('open');
      filterFab.style.display = '';
      filterSheet.style.display = '';
      filterFab.style.display = 'flex'; };

    document.getElementById('inspection-form').onsubmit = async function(e) {
  e.preventDefault();
  const id = this.dataset.centroId;
  const respuestas = {
    supervisorUCTD:                document.getElementById('supervisorUCTD').value,
    capacidadTransformador:        document.getElementById('capacidadTransformador').value,
    idTransformador:               document.getElementById('idTransformador').value,
    codigoApoyo:                   document.getElementById('codigoApoyo').value,
    cantidadClientes:              document.getElementById('cantidadClientes').value,
    riesgosNaturales:              document.getElementById('riesgosNaturales').value,
    observacionRiesgosNaturales:   document.getElementById('observacionRiesgosNaturales').value,
    requerimientoAcompanamiento:   document.getElementById('requerimientoAcompanamiento').value,
    observacionAcompanamiento:     document.getElementById('observacionAcompanamiento').value,
    presenciaPandillas:            document.getElementById('presenciaPandillas').value,
    observacionPandillas:          document.getElementById('observacionPandillas').value,
    otros:                         document.getElementById('otros').value,
    observacionOtros:              document.getElementById('observacionOtros').value,
    nivelConflictividad:           document.getElementById('nivelConflictividad').value,
    observacionConflictividad:     document.getElementById('observacionConflictividad').value,
    nivelRiesgo:                   document.getElementById('nivelRiesgo').value,
    observacionRiesgo:             document.getElementById('observacionRiesgo').value,
    nombreResponsable:             document.getElementById('nombreResponsable').value,
    cargoResponsable:              document.getElementById('cargoResponsable').value,
    institucionResponsable:        document.getElementById('institucionResponsable').value,
    telefonosResponsable:          document.getElementById('telefonosResponsable').value,
    observacionesGenerales:        document.getElementById('observacionesGenerales').value,
    fotos: []
  };

  const files = document.getElementById('fotosInput').files;

  if (files.length > 0) {
    for (const file of files) {
      const base64 = await toBase64(file);
      respuestas.fotos.push({
        nombre: file.name,
        contenido: base64
      });
    }
  }

  saveSpinner.style.display = 'flex';

  fetch(SHEET_API_BASE, {
    method: 'POST',
    body: JSON.stringify({
      id: id,
      respuestas: respuestas
    }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(data => {
    saveSpinner.style.display = 'none';
    document.getElementById('inspection-form').reset();
    sheet.classList.remove('open');
    filterFab.style.display = 'flex';
    snackbar.classList.add('show');
    const marker = markers.find(m => m.id === parseInt(id));
    if (marker) marker.setIcon(greenIcon);
    setTimeout(() => snackbar.classList.remove('show'), 3000);
  })
  .catch(err => {
    console.error(err);
    saveSpinner.style.display = 'none';
    alert("Error al guardar los datos.");
  });
};

function toBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

    loadMarkers();
  

// Eliminado: descarga manual de Excel.

</script>
<script>
document.getElementById('fotosInput').addEventListener('change', function(event) {
  const miniaturas = document.getElementById('miniaturasFotos');
  miniaturas.innerHTML = '';
  Array.from(event.target.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.width = '60px';
      img.style.height = '60px';
      img.style.objectFit = 'cover';
      img.style.border = '1px solid #ccc';
      miniaturas.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});
</script></body>
</html>
